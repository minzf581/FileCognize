<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileCognize - æ™ºèƒ½æ–‡æ¡£è¯†åˆ«ç³»ç»Ÿ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-area.dragover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-outline-primary {
            background: transparent;
            color: #4facfe;
            border: 2px solid #4facfe;
        }

        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 2px solid #6c757d;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .results-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .display-data {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .field-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .field-label {
            font-weight: 600;
            color: #333;
            min-width: 150px;
        }

        .field-value {
            flex: 1;
            margin: 0 15px;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .history-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .history-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .selected-count {
            margin-left: auto;
            font-weight: 600;
            color: #666;
        }

        .table-responsive {
            overflow-x: auto;
            margin: 20px 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .table-striped tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .table-hover tbody tr:hover {
            background: #e3f2fd;
        }

        .batch-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .camera-section {
            margin-top: 20px;
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* å…¨å±ç›¸æœºæ¨¡å¼ */
        .camera-section.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            background: #000;
            border-radius: 0;
            box-shadow: none;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .camera-section video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: #f0f0f0;
        }

        .camera-section.fullscreen video {
            width: 100vw;
            height: calc(100vh - 120px);
            max-width: none;
            border-radius: 0;
            box-shadow: none;
            object-fit: cover;
            background: #000;
        }

        .camera-controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .camera-section.fullscreen .camera-controls {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            margin: 0;
            padding: 0 20px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            max-width: 300px;
            margin: 0 auto;
        }

        .camera-section.fullscreen .camera-controls button {
            padding: 15px 25px;
            font-size: 16px;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        .camera-section.fullscreen #cameraStatus {
            position: fixed;
            top: 30px;
            left: 0;
            right: 0;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 1001;
        }

        .camera-section.fullscreen #capturedImage {
            width: 100vw;
            height: calc(100vh - 120px);
            object-fit: contain;
            background: #000;
        }

        .photo-confirm-controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .camera-section.fullscreen .photo-confirm-controls {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            margin: 0;
            padding: 0 20px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            max-width: 400px;
            margin: 0 auto;
        }

        .camera-section.fullscreen .photo-confirm-controls button {
            padding: 12px 20px;
            font-size: 14px;
            border-radius: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }

            .field-item {
                flex-direction: column;
                align-items: stretch;
            }

            .field-label {
                min-width: auto;
                margin-bottom: 8px;
            }

            .field-value {
                margin: 0;
            }

            .history-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .selected-count {
                margin-left: 0;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-search"></i> FileCognize</h1>
            <p>æ™ºèƒ½æ–‡æ¡£è¯†åˆ«ä¸æ•°æ®æå–ç³»ç»Ÿ</p>
        </div>
        
        <div class="content">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <h3><i class="fas fa-cloud-upload-alt"></i> ä¸Šä¼ æ–‡æ¡£</h3>
                    <p>æ”¯æŒå›¾ç‰‡å’ŒPDFæ–‡ä»¶ï¼Œç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</p>
                    
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open"></i> é€‰æ‹©æ–‡ä»¶
                        </button>
                        <button class="btn btn-info" onclick="openCamera()">
                            <i class="fas fa-camera"></i> æ‹ç…§è¯†åˆ«
                        </button>
                    </div>
                    
                    <input type="file" id="fileInput" accept="image/*,application/pdf" style="display: none;" />
                    
                    <!-- ç›¸æœºç•Œé¢ -->
                    <div class="camera-section" id="cameraSection" style="display: none;">
                        <div id="cameraStatus">æ­£åœ¨å¯åŠ¨ç›¸æœº...</div>
                        <video id="cameraVideo" autoplay playsinline muted></video>
                        <img id="capturedImage" style="display: none;" />
                        <div class="camera-controls">
                            <button class="btn btn-danger" onclick="closeCamera()">
                                <i class="fas fa-times"></i> å…³é—­ç›¸æœº
                            </button>
                            <button class="btn btn-success" id="captureBtn" onclick="capturePhoto()">
                                <i class="fas fa-camera"></i> æ‹ç…§
                            </button>
                        </div>
                        <!-- æ‹ç…§åçš„ç¡®è®¤ç•Œé¢ -->
                        <div class="photo-confirm-controls" id="photoConfirmControls" style="display: none;">
                            <button class="btn btn-danger" onclick="closeCamera()">
                                <i class="fas fa-times"></i> å–æ¶ˆ
                            </button>
                            <button class="btn btn-secondary" onclick="retakePhoto()">
                                <i class="fas fa-redo"></i> é‡æ–°æ‹ç…§
                            </button>
                            <button class="btn btn-primary" onclick="confirmPhoto()">
                                <i class="fas fa-check"></i> ç¡®è®¤è¯†åˆ«
                            </button>
                        </div>
                        <canvas id="captureCanvas" style="display: none;"></canvas>
                    </div>
                </div>
                
                <div class="progress" id="progress">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
            </div>

            <!-- è¯†åˆ«ç»“æœåŒºåŸŸ -->
            <div id="results" class="results-container" style="display: none;">
                <h3><i class="fas fa-eye"></i> è¯†åˆ«ç»“æœ</h3>
                
                <!-- å¯ç¼–è¾‘çš„è¯†åˆ«ç»“æœè¡¨å• -->
                <div class="edit-form" id="editForm" style="display: none;">
                    <div class="form-group">
                        <label for="editNumeroDocumento">Numero Documento:</label>
                        <input type="text" id="editNumeroDocumento" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editQuantita">Quantita:</label>
                        <input type="text" id="editQuantita" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editDescrizioneArticolo">Descrizione Articolo:</label>
                        <input type="text" id="editDescrizioneArticolo" class="form-control">
                    </div>
                    <div class="form-actions">
                        <button id="saveBtn" class="btn btn-success" onclick="saveEditedData()">
                            <i class="fas fa-save"></i> ä¿å­˜
                        </button>
                        <button id="cancelBtn" class="btn btn-secondary" onclick="cancelEdit()">
                            <i class="fas fa-times"></i> å–æ¶ˆ
                        </button>
                    </div>
                </div>
                
                <!-- æ˜¾ç¤ºè¯†åˆ«ç»“æœ -->
                <div id="displayData" class="display-data"></div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button id="editBtn" class="btn btn-info" onclick="editData()" disabled>
                        <i class="fas fa-edit"></i> ç¼–è¾‘
                    </button>
                    <button id="addToHistoryBtn" class="btn btn-success" onclick="addToHistory()" disabled>
                        <i class="fas fa-plus"></i> æ·»åŠ åˆ°å†å²è®°å½•
                    </button>
                    <button class="btn btn-primary" onclick="resetForm()">
                        <i class="fas fa-redo"></i> ç»§ç»­è¯†åˆ«
                    </button>
                </div>
            </div>

            <!-- å†å²è®°å½•åŒºåŸŸ -->
            <div id="historySection" class="history-section" style="display: none;">
                <h3><i class="fas fa-history"></i> å†å²è®°å½•</h3>
                <div class="history-controls">
                    <button id="selectAllBtn" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                        <i class="fas fa-check-square"></i> å…¨é€‰
                    </button>
                    <button id="selectNoneBtn" class="btn btn-sm btn-outline-secondary" onclick="selectNone()">
                        <i class="fas fa-square"></i> å–æ¶ˆå…¨é€‰
                    </button>
                    <span class="selected-count">å·²é€‰æ‹©: <span id="selectedCount">0</span> æ¡è®°å½•</span>
                </div>
                <div class="table-responsive">
                    <table id="historyTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th width="150">å¯¼å…¥æ—¶é—´</th>
                                <th width="120">Numero Documento</th>
                                <th width="100">Quantita</th>
                                <th>Descrizione Articolo</th>
                                <th width="100">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                
                <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                <div class="batch-actions">
                    <button id="exportSelectedPdfBtn" class="btn btn-primary" onclick="exportSelectedPDF()" disabled>
                        <i class="fas fa-file-pdf"></i> å¯¼å‡ºPDF (æ¨è)
                    </button>
                    <button id="exportSelectedBtn" class="btn btn-outline-primary" onclick="exportSelected()" disabled>
                        <i class="fas fa-download"></i> å¯¼å‡ºExcel
                    </button>
                    <button id="printSelectedBtn" class="btn btn-secondary" onclick="printSelected()" disabled>
                        <i class="fas fa-print"></i> æ‰“å°é€‰ä¸­è®°å½•
                    </button>
                    <button id="deleteSelectedBtn" class="btn btn-danger" onclick="deleteSelected()" disabled>
                        <i class="fas fa-trash"></i> åˆ é™¤é€‰ä¸­è®°å½•
                    </button>
                </div>
            </div>

            <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
            <div id="messageArea"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentSessionId = null;
        let currentData = null;
        let historyData = [];
        let cameraStream = null;

        // DOM å…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const results = document.getElementById('results');
        const displayData = document.getElementById('displayData');
        const editForm = document.getElementById('editForm');
        const historySection = document.getElementById('historySection');
        const historyTableBody = document.getElementById('historyTableBody');
        const messageArea = document.getElementById('messageArea');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadHistoryData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        // æ–‡ä»¶å¤„ç†
        async function handleFile(file) {
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
                showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶æˆ–PDFæ–‡ä»¶ï¼', 'danger');
                return;
            }

            const sessionId = generateSessionId();
            currentSessionId = sessionId;

            showProgress(true);
            updateProgress(10, 'å‡†å¤‡ä¸Šä¼ ...');

            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const endpoint = file.type === 'application/pdf' ? '/api/pdf-ocr-and-process' : '/api/ocr-and-process';

                updateProgress(30, 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');

                const response = await fetch(`${endpoint}?sessionId=${sessionId}`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(60, 'æ­£åœ¨è¯†åˆ«æ–‡æ¡£...');

                const data = await response.json();

                updateProgress(100, 'è¯†åˆ«å®Œæˆï¼');

                setTimeout(() => {
                    showProgress(false);
                    if (data.success) {
                        displayResult(data);
                    } else {
                        showMessage(data.message || 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
                    }
                }, 1000);

            } catch (error) {
                showProgress(false);
                showMessage(`å¤„ç†å¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // æ ¼å¼åŒ–è¯†åˆ«æ•°æ®
        function formatRecognizedData(extractedFields) {
            const formatted = { ...extractedFields };
            
            // 1. Quantitaå‰é¢åŠ ä¸Š"N'"è¡¨ç¤ºæ ¹æ•°
            if (formatted['Quantita'] && formatted['Quantita'] !== 'æœªè¯†åˆ«') {
                const quantita = formatted['Quantita'].toString().trim();
                if (quantita && !quantita.startsWith('N\'')) {
                    formatted['Quantita'] = `N' ${quantita}`;
                    console.log(`ğŸ“Š æ ¼å¼åŒ–Quantita: ${extractedFields['Quantita']} â†’ ${formatted['Quantita']}`);
                }
            }
            
            // 2. Descrizione Articolo ç‰¹æ®Šå¤„ç†
            if (formatted['Descrizione Articolo'] && formatted['Descrizione Articolo'] !== 'æœªè¯†åˆ«') {
                let descrizione = formatted['Descrizione Articolo'].toString().trim();
                
                // æ›¿æ¢ "A SCORCIARE" ä¸º "DA SCORCIARE"
                if (descrizione.includes('A SCORCIARE')) {
                    descrizione = descrizione.replace('A SCORCIARE', 'DA SCORCIARE');
                    console.log(`ğŸ“ æ›¿æ¢å†…å®¹: A SCORCIARE â†’ DA SCORCIARE`);
                }
                
                // åé¢åŠ ä¸Š"DDT"è¡¨ç¤ºå•æ®
                if (!descrizione.endsWith(' DDT')) {
                    descrizione = `${descrizione} DDT`;
                    console.log(`ğŸ“ æ·»åŠ DDTæ ‡è¯†: ${formatted['Descrizione Articolo']} â†’ ${descrizione}`);
                }
                
                formatted['Descrizione Articolo'] = descrizione;
            }
            
            return formatted;
        }

        // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
        function displayResult(data) {
            // æ ¼å¼åŒ–è¯†åˆ«æ•°æ®
            const formattedFields = formatRecognizedData(data.extractedFields);
            
            currentData = {
                ...data,
                extractedFields: formattedFields, // ä½¿ç”¨æ ¼å¼åŒ–åçš„æ•°æ®
                timestamp: new Date().toISOString()
            };

            let html = '';
            const fields = ['Numero Documento', 'Quantita', 'Descrizione Articolo'];
            
            fields.forEach(field => {
                const value = formattedFields[field] || 'æœªè¯†åˆ«';
                html += `
                    <div class="field-item">
                        <div class="field-label">${field}:</div>
                        <div class="field-value">${value}</div>
                    </div>
                `;
            });

            displayData.innerHTML = html;
            results.style.display = 'block';
            
            // å¯ç”¨æŒ‰é’®
            document.getElementById('editBtn').disabled = false;
            document.getElementById('addToHistoryBtn').disabled = false;

            showMessage('æ–‡æ¡£è¯†åˆ«å®Œæˆï¼æ•°æ®å·²è‡ªåŠ¨æ ¼å¼åŒ–ã€‚', 'success');
        }

        // ç¼–è¾‘æ•°æ®
        function editData() {
            if (!currentData) return;

            // å¡«å……ç¼–è¾‘è¡¨å•
            document.getElementById('editNumeroDocumento').value = currentData.extractedFields['Numero Documento'] || '';
            document.getElementById('editQuantita').value = currentData.extractedFields['Quantita'] || '';
            document.getElementById('editDescrizioneArticolo').value = currentData.extractedFields['Descrizione Articolo'] || '';

            // æ˜¾ç¤ºç¼–è¾‘è¡¨å•ï¼Œéšè—æ˜¾ç¤ºåŒºåŸŸ
            editForm.style.display = 'block';
            displayData.style.display = 'none';
        }

        // ä¿å­˜ç¼–è¾‘çš„æ•°æ®
        function saveEditedData() {
            const numeroDocumento = document.getElementById('editNumeroDocumento').value.trim();
            const quantita = document.getElementById('editQuantita').value.trim();
            const descrizioneArticolo = document.getElementById('editDescrizioneArticolo').value.trim();

            // åŸå§‹æ•°æ®ï¼ˆç¼–è¾‘å‰çš„æ•°æ®ï¼‰
            const rawFields = {
                'Numero Documento': numeroDocumento,
                'Quantita': quantita,
                'Descrizione Articolo': descrizioneArticolo
            };

            // åº”ç”¨æ ¼å¼åŒ–è§„åˆ™
            const formattedFields = formatRecognizedData(rawFields);

            // æ›´æ–°å½“å‰æ•°æ®
            currentData.extractedFields = formattedFields;

            // é‡æ–°æ˜¾ç¤ºç»“æœ
            displayResult(currentData);
            cancelEdit();
            
            showMessage('æ•°æ®å·²ä¿å­˜å¹¶æ ¼å¼åŒ–ï¼', 'success');
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            editForm.style.display = 'none';
            displayData.style.display = 'block';
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory() {
            if (!currentData) return;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè®°å½•
            const isDuplicate = historyData.some(item => 
                item.extractedFields['Numero Documento'] === currentData.extractedFields['Numero Documento'] &&
                item.extractedFields['Quantita'] === currentData.extractedFields['Quantita'] &&
                item.extractedFields['Descrizione Articolo'] === currentData.extractedFields['Descrizione Articolo']
            );

            if (isDuplicate) {
                showMessage('è¯¥è®°å½•å·²å­˜åœ¨äºå†å²è®°å½•ä¸­ï¼', 'warning');
                return;
            }

            // æ·»åŠ åˆ°å†å²è®°å½•
            const historyItem = {
                id: generateId(),
                timestamp: new Date().toISOString(),
                extractedFields: { ...currentData.extractedFields },
                filename: currentData.filename || 'æœªçŸ¥æ–‡ä»¶'
            };

            historyData.push(historyItem);
            saveHistoryData();
            renderHistoryTable();
            
            // æ˜¾ç¤ºå†å²è®°å½•åŒºåŸŸ
            historySection.style.display = 'block';
            
            showMessage('è®°å½•å·²æ·»åŠ åˆ°å†å²è®°å½•ï¼', 'success');
        }

        // æ¸²æŸ“å†å²è®°å½•è¡¨æ ¼
        function renderHistoryTable() {
            if (historyData.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">æš‚æ— å†å²è®°å½•</td></tr>';
                return;
            }

            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const sortedData = [...historyData].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            historyTableBody.innerHTML = sortedData.map(item => `
                <tr>
                    <td>
                        <input type="checkbox" class="record-checkbox" value="${item.id}" onchange="updateSelectedCount()">
                    </td>
                    <td>${formatDateTime(item.timestamp)}</td>
                    <td>${item.extractedFields['Numero Documento'] || '-'}</td>
                    <td>${item.extractedFields['Quantita'] || '-'}</td>
                    <td>${item.extractedFields['Descrizione Articolo'] || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            updateSelectedCount();
        }

        // é€‰æ‹©/å–æ¶ˆé€‰æ‹©æ‰€æœ‰è®°å½•
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }

        function selectAll() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleSelectAll();
        }

        function selectNone() {
            document.getElementById('selectAllCheckbox').checked = false;
            toggleSelectAll();
        }

        // æ›´æ–°é€‰ä¸­è®¡æ•°
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            const count = checkboxes.length;
            
            document.getElementById('selectedCount').textContent = count;
            
            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€
            const hasSelection = count > 0;
            document.getElementById('exportSelectedPdfBtn').disabled = !hasSelection; // PDFå¯¼å‡ºæŒ‰é’®ï¼ˆä¸»è¦ï¼‰
            document.getElementById('exportSelectedBtn').disabled = !hasSelection;    // Excelå¯¼å‡ºæŒ‰é’®ï¼ˆå¤‡é€‰ï¼‰
            document.getElementById('printSelectedBtn').disabled = !hasSelection;
            document.getElementById('deleteSelectedBtn').disabled = !hasSelection;
        }

        // è®¾å¤‡æ£€æµ‹å‡½æ•°
        function detectDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const isTablet = /ipad|android(?!.*mobile)/i.test(userAgent);
            
            return {
                isMobile: isMobile && !isTablet,
                isTablet: isTablet,
                isDesktop: !isMobile && !isTablet,
                userAgent: userAgent
            };
        }

        // å¯¼å‡ºé€‰ä¸­è®°å½• - æ”¯æŒè·¨è®¾å¤‡æ ¼å¼ä¸€è‡´æ€§
        async function exportSelected() {
            const selectedIds = getSelectedRecordIds();
            if (selectedIds.length === 0) {
                showMessage('è¯·é€‰æ‹©è¦å¯¼å‡ºçš„è®°å½•ï¼', 'warning');
                return;
            }

            try {
                const selectedRecords = historyData.filter(item => selectedIds.includes(item.id));
                const device = detectDevice();
                
                console.log('ğŸ“± è®¾å¤‡ä¿¡æ¯:', device);
                
                // åˆ›å»ºä¸´æ—¶ä¼šè¯ID
                const tempSessionId = generateSessionId();
                
                // æ ¹æ®è®¾å¤‡ç±»å‹é€‰æ‹©å¯¼å‡ºæ–¹å¼
                let exportEndpoint = '/api/export-selected';
                let exportMode = 'standard';
                
                if (device.isMobile) {
                    exportMode = 'mobile-optimized';
                    console.log('ğŸ“± ä½¿ç”¨ç§»åŠ¨ç«¯ä¼˜åŒ–å¯¼å‡ºæ¨¡å¼');
                    showMessage('æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼Œä½¿ç”¨ä¼˜åŒ–å¯¼å‡ºæ¨¡å¼...', 'info');
                } else if (device.isTablet) {
                    exportMode = 'tablet-optimized';
                    console.log('ğŸ“± ä½¿ç”¨å¹³æ¿ä¼˜åŒ–å¯¼å‡ºæ¨¡å¼');
                } else {
                    exportMode = 'desktop-standard';
                    console.log('ğŸ’» ä½¿ç”¨æ¡Œé¢æ ‡å‡†å¯¼å‡ºæ¨¡å¼');
                }
                
                // å‘é€é€‰ä¸­çš„è®°å½•åˆ°åç«¯ï¼ŒåŒ…å«è®¾å¤‡ä¿¡æ¯
                const response = await fetch(exportEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: tempSessionId,
                        records: selectedRecords,
                        deviceInfo: {
                            type: device.isMobile ? 'mobile' : device.isTablet ? 'tablet' : 'desktop',
                            userAgent: device.userAgent,
                            exportMode: exportMode
                        }
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´æ–‡ä»¶å
                    const timestamp = formatDateTime(new Date().toISOString()).replace(/[:\s]/g, '-');
                    const deviceSuffix = device.isMobile ? '_Mobile' : device.isTablet ? '_Tablet' : '';
                    a.download = `FileCognize_Selected${deviceSuffix}_${timestamp}.xlsx`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    let successMessage = `âœ… æˆåŠŸå¯¼å‡º ${selectedIds.length} æ¡è®°å½•ä¸ºExcelæ ¼å¼ï¼`;
                    if (device.isMobile) {
                        successMessage += ' (ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆæœ¬)';
                    } else if (device.isTablet) {
                        successMessage += ' (å¹³æ¿ä¼˜åŒ–ç‰ˆæœ¬)';
                    }
                    showMessage(successMessage, 'success');
                    
                    // ä¸ºç”¨æˆ·æä¾›Excelæ ¼å¼è¯´æ˜
                    setTimeout(() => {
                        showMessage('ğŸ“Š Excelæ ¼å¼ä¼˜åŠ¿ï¼šå¯ç¼–è¾‘æ•°æ®ï¼Œæ”¯æŒå…¬å¼è®¡ç®—å’Œè¿›ä¸€æ­¥å¤„ç†', 'info');
                    }, 2000);
                    
                    // ä¸ºç§»åŠ¨ç«¯ç”¨æˆ·æä¾›é¢å¤–è¯´æ˜
                    if (device.isMobile || device.isTablet) {
                        setTimeout(() => {
                            showMessage('ğŸ¨ ç§»åŠ¨ç«¯ä¸“ç”¨ï¼šå®Œå…¨ä¿æŒåŸå§‹Excelæ ¼å¼ï¼ŒåŒ…å«æ‰€æœ‰è¡¨å¤´ä¿¡æ¯', 'info');
                        }, 2000);
                        
                        setTimeout(() => {
                            showMessage('ğŸ“‹ è¡¨å¤´å®Œæ•´ï¼šå…¬å¸ä¿¡æ¯ã€æ–‡æ¡£æ ‡é¢˜ã€åˆå¹¶å•å…ƒæ ¼å…¨éƒ¨ä¿æŒ', 'success');
                        }, 4000);
                        
                        setTimeout(() => {
                            showMessage('ğŸ“± å¯ç›´æ¥æ‰“å¼€ExcelæŸ¥çœ‹å®Œæ•´æ–‡æ¡£ï¼Œæ ¼å¼ä¸åŸæ¨¡æ¿100%ä¸€è‡´', 'info');
                        }, 6000);
                    }
                } else {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // å¯¼å‡ºé€‰ä¸­è®°å½•ä¸ºPDF - é¿å…è·¨å¹³å°å·®å¼‚
        async function exportSelectedPDF() {
            const selectedIds = getSelectedRecordIds();
            if (selectedIds.length === 0) {
                showMessage('è¯·é€‰æ‹©è¦å¯¼å‡ºçš„è®°å½•ï¼', 'warning');
                return;
            }

            try {
                const selectedRecords = historyData.filter(item => selectedIds.includes(item.id));
                const device = detectDevice();
                
                console.log('ğŸ“„ PDFå¯¼å‡ºè®¾å¤‡ä¿¡æ¯:', device);
                
                // åˆ›å»ºä¸´æ—¶ä¼šè¯ID
                const tempSessionId = generateSessionId();
                
                showMessage('æ­£åœ¨ç”ŸæˆPDFæ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
                
                // å‘é€é€‰ä¸­çš„è®°å½•åˆ°åç«¯ç”ŸæˆPDF
                const response = await fetch('/api/export-selected-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: tempSessionId,
                        records: selectedRecords,
                        deviceInfo: {
                            type: device.isMobile ? 'mobile' : device.isTablet ? 'tablet' : 'desktop',
                            userAgent: device.userAgent,
                            exportMode: 'pdf-export'
                        }
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´æ–‡ä»¶å
                    const timestamp = formatDateTime(new Date().toISOString()).replace(/[:\s]/g, '-');
                    const deviceSuffix = device.isMobile ? '_Mobile' : device.isTablet ? '_Tablet' : '';
                    a.download = `FileCognize_Selected${deviceSuffix}_${timestamp}.pdf`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    let successMessage = `âœ… æˆåŠŸå¯¼å‡º ${selectedIds.length} æ¡è®°å½•ä¸ºPDFï¼`;
                    showMessage(successMessage, 'success');
                    
                    // ä¸ºç”¨æˆ·æä¾›PDFä¼˜åŠ¿è¯´æ˜
                    setTimeout(() => {
                        showMessage('ğŸ“„ PDFæ ¼å¼ä¼˜åŠ¿ï¼šè·¨å¹³å°å®Œå…¨ä¸€è‡´ï¼Œæ— è®ºåœ¨Windowsã€Macè¿˜æ˜¯æ‰‹æœºä¸Šéƒ½æ˜¾ç¤ºç›¸åŒ', 'info');
                    }, 2000);
                    
                    setTimeout(() => {
                        showMessage('ğŸ–¨ï¸ PDFæ–‡ä»¶å¯ç›´æ¥æ‰“å°æˆ–åˆ†äº«ï¼Œæ ¼å¼æ°¸ä¸å˜å½¢ï¼Œé€‚åˆæ­£å¼æ–‡æ¡£å­˜æ¡£', 'success');
                    }, 4000);
                    
                    setTimeout(() => {
                        showMessage('ğŸ’¡ æç¤ºï¼šå¦‚éœ€ç¼–è¾‘æ•°æ®ï¼Œå¯ä½¿ç”¨"å¯¼å‡ºExcel"æŒ‰é’®è·å–å¯ç¼–è¾‘ç‰ˆæœ¬', 'info');
                    }, 6000);
                } else {
                    throw new Error('PDFå¯¼å‡ºå¤±è´¥');
                }
            } catch (error) {
                console.error('PDFå¯¼å‡ºå¤±è´¥:', error);
                showMessage(`PDFå¯¼å‡ºå¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // æ‰“å°é€‰ä¸­è®°å½•
        async function printSelected() {
            const selectedIds = getSelectedRecordIds();
            if (selectedIds.length === 0) {
                showMessage('è¯·é€‰æ‹©è¦æ‰“å°çš„è®°å½•ï¼', 'warning');
                return;
            }

            try {
                const selectedRecords = historyData.filter(item => selectedIds.includes(item.id));
                
                // åˆ›å»ºä¸´æ—¶ä¼šè¯ID
                const tempSessionId = generateSessionId();
                
                // å‘é€é€‰ä¸­çš„è®°å½•åˆ°åç«¯ç”Ÿæˆæ‰“å°é¡µé¢
                const response = await fetch('/api/print-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: tempSessionId,
                        records: selectedRecords
                    })
                });

                if (response.ok) {
                    // è·å–PDFæ–‡ä»¶çš„blobæ•°æ®
                    const pdfBlob = await response.blob();
                    
                    // åˆ›å»ºPDFæ–‡ä»¶çš„URL
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    // åœ¨æ–°çª—å£ä¸­æ‰“å¼€PDFæ–‡ä»¶
                    const printWindow = window.open(pdfUrl, '_blank');
                    
                    // æ¸…ç†URLå¯¹è±¡ï¼ˆå»¶è¿Ÿæ¸…ç†ï¼Œç¡®ä¿PDFå·²åŠ è½½ï¼‰
                    setTimeout(() => {
                        URL.revokeObjectURL(pdfUrl);
                    }, 10000);
                    
                    showMessage(`æˆåŠŸå‡†å¤‡æ‰“å° ${selectedIds.length} æ¡è®°å½•ï¼PDFæ–‡ä»¶å·²åœ¨æ–°çª—å£ä¸­æ‰“å¼€`, 'success');
                } else {
                    throw new Error('æ‰“å°å‡†å¤‡å¤±è´¥');
                }
            } catch (error) {
                showMessage(`æ‰“å°å¤±è´¥: ${error.message}`, 'danger');
            }
        }

        // åˆ é™¤é€‰ä¸­è®°å½•
        function deleteSelected() {
            const selectedIds = getSelectedRecordIds();
            if (selectedIds.length === 0) {
                showMessage('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•ï¼', 'warning');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                historyData = historyData.filter(item => !selectedIds.includes(item.id));
                saveHistoryData();
                renderHistoryTable();
                
                showMessage(`æˆåŠŸåˆ é™¤ ${selectedIds.length} æ¡è®°å½•ï¼`, 'success');
            }
        }

        // åˆ é™¤å•æ¡è®°å½•
        function deleteRecord(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                historyData = historyData.filter(item => item.id !== id);
                saveHistoryData();
                renderHistoryTable();
                
                showMessage('è®°å½•å·²åˆ é™¤ï¼', 'success');
            }
        }

        // è·å–é€‰ä¸­è®°å½•çš„ID
        function getSelectedRecordIds() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        // ç›¸æœºåŠŸèƒ½
        async function openCamera() {
            try {
                // è¯·æ±‚é«˜è´¨é‡è§†é¢‘æµï¼Œæå‡è¯†åˆ«å‡†ç¡®ç‡
                const constraints = {
                    video: {
                        facingMode: 'environment', // ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
                        width: { ideal: 1920, min: 1280 }, // é«˜åˆ†è¾¨ç‡
                        height: { ideal: 1080, min: 720 },
                        aspectRatio: { ideal: 16/9 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('cameraVideo');
                const cameraSection = document.getElementById('cameraSection');
                
                video.srcObject = cameraStream;
                
                // å¯ç”¨å…¨å±æ¨¡å¼
                cameraSection.classList.add('fullscreen');
                cameraSection.style.display = 'block';
                
                // é˜»æ­¢é¡µé¢æ»šåŠ¨
                document.body.style.overflow = 'hidden';
                
                document.getElementById('cameraStatus').textContent = 'ç›¸æœºå·²å°±ç»ªï¼Œå¯¹å‡†æ–‡æ¡£ç‚¹å‡»æ‹ç…§æŒ‰é’®';
                
                // æ·»åŠ ESCé”®é€€å‡ºåŠŸèƒ½
                document.addEventListener('keydown', handleEscapeKey);
                
            } catch (error) {
                console.error('ç›¸æœºå¯åŠ¨å¤±è´¥:', error);
                showMessage('æ— æ³•è®¿é—®ç›¸æœºï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®æˆ–å°è¯•ä½¿ç”¨å…¶ä»–æµè§ˆå™¨', 'danger');
            }
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // æ¸…ç†é¢„è§ˆå›¾ç‰‡èµ„æº
            const capturedImage = document.getElementById('capturedImage');
            if (capturedImage.src) {
                URL.revokeObjectURL(capturedImage.src);
                capturedImage.src = '';
            }
            
            const cameraSection = document.getElementById('cameraSection');
            cameraSection.classList.remove('fullscreen');
            cameraSection.style.display = 'none';
            
            // é‡ç½®ç•Œé¢çŠ¶æ€
            document.getElementById('cameraVideo').style.display = 'block';
            document.getElementById('capturedImage').style.display = 'none';
            document.querySelector('.camera-controls').style.display = 'flex';
            document.getElementById('photoConfirmControls').style.display = 'none';
            
            // æ¢å¤é¡µé¢æ»šåŠ¨
            document.body.style.overflow = 'auto';
            
            // ç§»é™¤ESCé”®ç›‘å¬
            document.removeEventListener('keydown', handleEscapeKey);
            
            // æ¸…ç†æ•°æ®
            capturedPhotoBlob = null;
        }

        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                closeCamera();
            }
        }

        let capturedPhotoBlob = null; // å­˜å‚¨æ‹æ‘„çš„ç…§ç‰‡

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('captureCanvas');
            const context = canvas.getContext('2d');
            
            // ä½¿ç”¨æ›´é«˜çš„åˆ†è¾¨ç‡è¿›è¡Œæ‹ç…§ï¼Œæå‡OCRè¯†åˆ«ç‡
            const scale = 2; // 2å€è¶…çº§é‡‡æ ·
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            
            // è®¾ç½®é«˜è´¨é‡ç»˜åˆ¶
            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = 'high';
            
            // ç¼©æ”¾ç”»å¸ƒä»¥è·å¾—æ›´é«˜è´¨é‡
            context.scale(scale, scale);
            context.drawImage(video, 0, 0);
            
            // å›¾åƒé¢„å¤„ç†ä»¥æå‡OCRè¯†åˆ«ç‡
            try {
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const processedImageData = enhanceImageForOCR(imageData);
                context.putImageData(processedImageData, 0, 0);
                console.log('âœ… å›¾åƒé¢„å¤„ç†å®Œæˆ');
            } catch (error) {
                console.warn('âš ï¸ å›¾åƒé¢„å¤„ç†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å›¾åƒ:', error.message);
            }
            
            // ç”Ÿæˆç…§ç‰‡é¢„è§ˆ
            canvas.toBlob(blob => {
                console.log('æ‹ç…§å®Œæˆï¼Œå›¾ç‰‡å¤§å°:', (blob.size / 1024 / 1024).toFixed(2), 'MB');
                
                // å­˜å‚¨ç…§ç‰‡blobä¾›åç»­ä½¿ç”¨
                capturedPhotoBlob = blob;
                
                // æ˜¾ç¤ºç…§ç‰‡é¢„è§ˆ
                const capturedImage = document.getElementById('capturedImage');
                const imageUrl = URL.createObjectURL(blob);
                capturedImage.src = imageUrl;
                
                // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                document.getElementById('cameraVideo').style.display = 'none';
                document.getElementById('capturedImage').style.display = 'block';
                
                // è¯„ä¼°å›¾åƒè´¨é‡å¹¶æä¾›å»ºè®®
                evaluatePhotoQuality(blob).then(quality => {
                    if (quality.score >= 80) {
                        document.getElementById('cameraStatus').textContent = 'âœ… ç…§ç‰‡è´¨é‡è‰¯å¥½ï¼Œæ–‡å­—æ¸…æ™°å¯è§';
                        document.getElementById('cameraStatus').style.color = '#28a745';
                    } else if (quality.score >= 60) {
                        document.getElementById('cameraStatus').textContent = 'âš ï¸ ç…§ç‰‡è´¨é‡ä¸€èˆ¬ï¼Œå»ºè®®é‡æ–°æ‹ç…§';
                        document.getElementById('cameraStatus').style.color = '#ffc107';
                    } else {
                        document.getElementById('cameraStatus').textContent = 'âŒ ç…§ç‰‡è´¨é‡è¾ƒå·®ï¼Œå»ºè®®é‡æ–°æ‹ç…§';
                        document.getElementById('cameraStatus').style.color = '#dc3545';
                    }
                }).catch(() => {
                    document.getElementById('cameraStatus').textContent = 'è¯·ç¡®è®¤ç…§ç‰‡è´¨é‡ï¼Œæ–‡å­—æ˜¯å¦æ¸…æ™°å¯è§';
                });
                
                // åˆ‡æ¢æ§åˆ¶æŒ‰é’®
                document.querySelector('.camera-controls').style.display = 'none';
                document.getElementById('photoConfirmControls').style.display = 'flex';
                
            }, 'image/jpeg', 0.95); // ä½¿ç”¨95%è´¨é‡è€Œä¸æ˜¯80%
        }

        async function confirmPhoto() {
            if (!capturedPhotoBlob) {
                showMessage('æœªæ‰¾åˆ°æ‹ç…§æ•°æ®ï¼Œè¯·é‡æ–°æ‹ç…§', 'danger');
                return;
            }
            
            // åˆ›å»ºé«˜è´¨é‡çš„æ–‡ä»¶å¯¹è±¡
            const file = new File([capturedPhotoBlob], 'camera-capture.jpg', { 
                type: 'image/jpeg',
                lastModified: Date.now()
            });
            
            console.log('ğŸ“¸ æ‹ç…§æ–‡ä»¶ä¿¡æ¯:', {
                name: file.name,
                size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                type: file.type
            });
            
            closeCamera();
            
            // ä½¿ç”¨å¢å¼ºçš„æ–‡ä»¶å¤„ç†æµç¨‹
            await handleCameraFile(file);
        }

        // ä¸“é—¨ä¸ºæ‹ç…§æ–‡ä»¶ä¼˜åŒ–çš„å¤„ç†å‡½æ•°
        async function handleCameraFile(file) {
            if (!file.type.startsWith('image/')) {
                showMessage('æ‹ç…§æ–‡ä»¶ç±»å‹é”™è¯¯ï¼Œè¯·é‡æ–°æ‹ç…§', 'danger');
                return;
            }

            const sessionId = generateSessionId();
            currentSessionId = sessionId;

            showProgress(true);
            updateProgress(5, 'æ­£åœ¨å‡†å¤‡æ‹ç…§æ–‡ä»¶...');

            try {
                const formData = new FormData();
                formData.append('file', file);
                
                // æ·»åŠ é¢å¤–çš„æ‹ç…§æ ‡è¯†ï¼Œå¸®åŠ©åç«¯ä¼˜åŒ–å¤„ç†
                formData.append('source', 'camera');
                formData.append('enhanced', 'true'); // æ ‡è¯†å·²ç»è¿‡å‰ç«¯å›¾åƒå¢å¼º
                
                updateProgress(15, 'æ­£åœ¨ä¸Šä¼ æ‹ç…§æ–‡ä»¶...');

                const response = await fetch(`/api/ocr-and-process?sessionId=${sessionId}`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(40, 'æ­£åœ¨è¿›è¡ŒOCRè¯†åˆ«...');

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                updateProgress(85, 'æ­£åœ¨å¤„ç†è¯†åˆ«ç»“æœ...');

                // æ·»åŠ å»¶è¿Ÿä»¥æ˜¾ç¤ºè¿›åº¦
                await new Promise(resolve => setTimeout(resolve, 500));

                updateProgress(100, 'è¯†åˆ«å®Œæˆï¼');

                setTimeout(() => {
                    showProgress(false);
                    if (data.success) {
                        console.log('ğŸ“Š æ‹ç…§è¯†åˆ«æˆåŠŸ:', data);
                        showMessage('æ‹ç…§è¯†åˆ«æˆåŠŸï¼', 'success');
                        displayResult(data);
                    } else {
                        console.error('âŒ æ‹ç…§è¯†åˆ«å¤±è´¥:', data);
                        showMessage(`æ‹ç…§è¯†åˆ«å¤±è´¥: ${data.error || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                        
                        // æä¾›é‡æ–°æ‹ç…§çš„å»ºè®®
                        setTimeout(() => {
                            showMessage('å»ºè®®é‡æ–°æ‹ç…§ï¼Œç¡®ä¿æ–‡æ¡£æ¸…æ™°ä¸”å…‰çº¿å……è¶³', 'warning');
                        }, 3000);
                    }
                }, 1000);

            } catch (error) {
                console.error('âŒ æ‹ç…§å¤„ç†å¤±è´¥:', error);
                showProgress(false);
                
                let errorMessage = 'æ‹ç…§è¯†åˆ«å¤±è´¥';
                if (error.message.includes('timeout')) {
                    errorMessage = 'è¯†åˆ«è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                } else if (error.message.includes('ç½‘ç»œ')) {
                    errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•';
                } else if (error.message.includes('æœåŠ¡å™¨')) {
                    errorMessage = 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                } else {
                    errorMessage = `å¤„ç†å¤±è´¥: ${error.message}`;
                }
                
                showMessage(errorMessage, 'danger');
                
                // æä¾›æ“ä½œå»ºè®®
                setTimeout(() => {
                    showMessage('è¯·å°è¯•é‡æ–°æ‹ç…§æˆ–ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½', 'info');
                }, 3000);
            }
        }

        function retakePhoto() {
            // æ¸…ç†é¢„è§ˆå›¾ç‰‡
            const capturedImage = document.getElementById('capturedImage');
            if (capturedImage.src) {
                URL.revokeObjectURL(capturedImage.src);
            }
            
            // é‡ç½®ç•Œé¢
            document.getElementById('cameraVideo').style.display = 'block';
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('cameraStatus').textContent = 'ç›¸æœºå·²å°±ç»ªï¼Œå¯¹å‡†æ–‡æ¡£ç‚¹å‡»æ‹ç…§æŒ‰é’®';
            
            // åˆ‡æ¢æ§åˆ¶æŒ‰é’®
            document.querySelector('.camera-controls').style.display = 'flex';
            document.getElementById('photoConfirmControls').style.display = 'none';
            
            // æ¸…ç†æ•°æ®
            capturedPhotoBlob = null;
        }

        // å›¾åƒè´¨é‡è¯„ä¼°å‡½æ•°
        async function evaluatePhotoQuality(blob) {
            return new Promise((resolve, reject) => {
                try {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        let totalVariance = 0;
                        let brightPixels = 0;
                        let darkPixels = 0;
                        let totalBrightness = 0;
                        
                        // è®¡ç®—å›¾åƒæ¸…æ™°åº¦å’Œå¯¹æ¯”åº¦
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            
                            const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                            totalBrightness += gray;
                            
                            if (gray > 200) brightPixels++;
                            if (gray < 50) darkPixels++;
                            
                            // è®¡ç®—å±€éƒ¨æ–¹å·®ï¼ˆæ¸…æ™°åº¦æŒ‡æ ‡ï¼‰
                            if (i > 0 && i < data.length - 4) {
                                const prevGray = 0.299 * data[i-4] + 0.587 * data[i-3] + 0.114 * data[i-2];
                                totalVariance += Math.abs(gray - prevGray);
                            }
                        }
                        
                        const pixelCount = data.length / 4;
                        const avgBrightness = totalBrightness / pixelCount;
                        const avgVariance = totalVariance / pixelCount;
                        const contrastRatio = (brightPixels + darkPixels) / pixelCount;
                        
                        // è®¡ç®—è´¨é‡åˆ†æ•°
                        let score = 50; // åŸºç¡€åˆ†æ•°
                        
                        // æ¸…æ™°åº¦è¯„åˆ†ï¼ˆ0-30åˆ†ï¼‰
                        if (avgVariance > 15) score += 30;
                        else if (avgVariance > 10) score += 20;
                        else if (avgVariance > 5) score += 10;
                        
                        // äº®åº¦è¯„åˆ†ï¼ˆ0-20åˆ†ï¼‰
                        if (avgBrightness >= 80 && avgBrightness <= 180) score += 20;
                        else if (avgBrightness >= 60 && avgBrightness <= 200) score += 10;
                        
                        // å¯¹æ¯”åº¦è¯„åˆ†ï¼ˆ0-20åˆ†ï¼‰
                        if (contrastRatio >= 0.3 && contrastRatio <= 0.7) score += 20;
                        else if (contrastRatio >= 0.2 && contrastRatio <= 0.8) score += 10;
                        
                        // å›¾åƒå°ºå¯¸è¯„åˆ†ï¼ˆ0-10åˆ†ï¼‰
                        if (canvas.width >= 800 && canvas.height >= 600) score += 10;
                        else if (canvas.width >= 640 && canvas.height >= 480) score += 5;
                        
                        resolve({
                            score: Math.min(100, Math.max(0, score)),
                            brightness: avgBrightness,
                            sharpness: avgVariance,
                            contrast: contrastRatio,
                            dimensions: { width: canvas.width, height: canvas.height }
                        });
                    };
                    
                    img.onerror = () => reject(new Error('å›¾åƒåŠ è½½å¤±è´¥'));
                    img.src = URL.createObjectURL(blob);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // å›¾åƒå¢å¼ºå‡½æ•°ï¼Œæå‡OCRè¯†åˆ«ç‡
        function enhanceImageForOCR(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // åˆ›å»ºæ–°çš„å›¾åƒæ•°æ®
            const enhancedData = new Uint8ClampedArray(data);
            
            // 1. æå‡å¯¹æ¯”åº¦å’Œäº®åº¦
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // è®¡ç®—ç°åº¦å€¼
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                
                // åº”ç”¨å¯¹æ¯”åº¦å¢å¼º
                const contrast = 1.3; // å¢å¼ºå¯¹æ¯”åº¦
                const brightness = 10;  // è½»å¾®æå‡äº®åº¦
                
                let newR = contrast * (r - 128) + 128 + brightness;
                let newG = contrast * (g - 128) + 128 + brightness;
                let newB = contrast * (b - 128) + 128 + brightness;
                
                // å¦‚æœåƒç´ åå‘ç°è‰²ï¼Œå¢å¼ºé»‘ç™½å¯¹æ¯”
                if (Math.abs(r - g) < 30 && Math.abs(g - b) < 30 && Math.abs(r - b) < 30) {
                    if (gray < 140) {
                        // ä½¿æš—éƒ¨æ›´æš—
                        newR = Math.max(0, newR - 20);
                        newG = Math.max(0, newG - 20);
                        newB = Math.max(0, newB - 20);
                    } else {
                        // ä½¿äº®éƒ¨æ›´äº®
                        newR = Math.min(255, newR + 15);
                        newG = Math.min(255, newG + 15);
                        newB = Math.min(255, newB + 15);
                    }
                }
                
                // é™åˆ¶åƒç´ å€¼èŒƒå›´
                enhancedData[i] = Math.max(0, Math.min(255, newR));
                enhancedData[i + 1] = Math.max(0, Math.min(255, newG));
                enhancedData[i + 2] = Math.max(0, Math.min(255, newB));
                enhancedData[i + 3] = data[i + 3]; // ä¿æŒalphaé€šé“
            }
            
            return new ImageData(enhancedData, width, height);
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            currentData = null;
            currentSessionId = null;
            
            results.style.display = 'none';
            editForm.style.display = 'none';
            displayData.style.display = 'block';
            
            document.getElementById('editBtn').disabled = true;
            document.getElementById('addToHistoryBtn').disabled = true;
            
            fileInput.value = '';
            
            // å¦‚æœæœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºå†å²è®°å½•åŒºåŸŸ
            if (historyData.length > 0) {
                historySection.style.display = 'block';
            }
        }

        // å·¥å…·å‡½æ•°
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateId() {
            return 'record_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function showProgress(show) {
            progress.style.display = show ? 'block' : 'none';
            if (!show) {
                updateProgress(0, '');
            }
        }

        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = text || `${percent}%`;
        }

        function showMessage(message, type = 'info') {
            const alertClass = `alert-${type}`;
            const iconClass = type === 'success' ? 'fa-check-circle' : 
                             type === 'danger' ? 'fa-exclamation-circle' : 
                             type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            const messageHtml = `
                <div class="alert ${alertClass}">
                    <i class="fas ${iconClass}"></i> ${message}
                </div>
            `;
            
            messageArea.innerHTML = messageHtml;
            
            // 3ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }

        // æœ¬åœ°å­˜å‚¨åŠŸèƒ½
        function saveHistoryData() {
            localStorage.setItem('fileCognizeHistory', JSON.stringify(historyData));
        }

        function loadHistoryData() {
            const saved = localStorage.getItem('fileCognizeHistory');
            if (saved) {
                historyData = JSON.parse(saved);
                if (historyData.length > 0) {
                    historySection.style.display = 'block';
                    renderHistoryTable();
                }
            }
        }
    </script>
</body>
</html> 
</html> 