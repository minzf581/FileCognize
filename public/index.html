<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileCognize - 智能文档识别系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-area.dragover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-outline-primary {
            background: transparent;
            color: #4facfe;
            border: 2px solid #4facfe;
        }

        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 2px solid #6c757d;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .results-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .display-data {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .field-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .field-label {
            font-weight: 600;
            color: #333;
            min-width: 150px;
        }

        .field-value {
            flex: 1;
            margin: 0 15px;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .history-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .history-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .selected-count {
            margin-left: auto;
            font-weight: 600;
            color: #666;
        }

        .table-responsive {
            overflow-x: auto;
            margin: 20px 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .table-striped tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .table-hover tbody tr:hover {
            background: #e3f2fd;
        }

        .batch-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .camera-section {
            margin-top: 20px;
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .camera-section video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: #f0f0f0;
        }

        .camera-controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }

            .field-item {
                flex-direction: column;
                align-items: stretch;
            }

            .field-label {
                min-width: auto;
                margin-bottom: 8px;
            }

            .field-value {
                margin: 0;
            }

            .history-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .selected-count {
                margin-left: 0;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-search"></i> FileCognize</h1>
            <p>智能文档识别与数据提取系统</p>
        </div>
        
        <div class="content">
            <!-- 上传区域 -->
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <h3><i class="fas fa-cloud-upload-alt"></i> 上传文档</h3>
                    <p>支持图片和PDF文件，点击选择文件或拖拽到此处</p>
                    
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open"></i> 选择文件
                        </button>
                        <button class="btn btn-info" onclick="openCamera()">
                            <i class="fas fa-camera"></i> 拍照识别
                        </button>
                    </div>
                    
                    <input type="file" id="fileInput" accept="image/*,application/pdf" style="display: none;" />
                    
                    <!-- 相机界面 -->
                    <div class="camera-section" id="cameraSection" style="display: none;">
                        <div id="cameraStatus">正在启动相机...</div>
                        <video id="cameraVideo" autoplay playsinline muted></video>
                        <div class="camera-controls">
                            <button class="btn btn-success" onclick="capturePhoto()">
                                <i class="fas fa-camera"></i> 拍照
                            </button>
                            <button class="btn btn-danger" onclick="closeCamera()">
                                <i class="fas fa-times"></i> 关闭相机
                            </button>
                        </div>
                        <canvas id="captureCanvas" style="display: none;"></canvas>
                    </div>
                </div>
                
                <div class="progress" id="progress">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
            </div>

            <!-- 识别结果区域 -->
            <div id="results" class="results-container" style="display: none;">
                <h3><i class="fas fa-eye"></i> 识别结果</h3>
                
                <!-- 可编辑的识别结果表单 -->
                <div class="edit-form" id="editForm" style="display: none;">
                    <div class="form-group">
                        <label for="editNumeroDocumento">Numero Documento:</label>
                        <input type="text" id="editNumeroDocumento" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editQuantita">Quantita:</label>
                        <input type="text" id="editQuantita" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editDescrizioneArticolo">Descrizione Articolo:</label>
                        <input type="text" id="editDescrizioneArticolo" class="form-control">
                    </div>
                    <div class="form-actions">
                        <button id="saveBtn" class="btn btn-success" onclick="saveEditedData()">
                            <i class="fas fa-save"></i> 保存
                        </button>
                        <button id="cancelBtn" class="btn btn-secondary" onclick="cancelEdit()">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </div>
                
                <!-- 显示识别结果 -->
                <div id="displayData" class="display-data"></div>
                
                <!-- 操作按钮 -->
                <div class="action-buttons">
                    <button id="editBtn" class="btn btn-info" onclick="editData()" disabled>
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                    <button id="addToHistoryBtn" class="btn btn-success" onclick="addToHistory()" disabled>
                        <i class="fas fa-plus"></i> 添加到历史记录
                    </button>
                    <button class="btn btn-primary" onclick="resetForm()">
                        <i class="fas fa-redo"></i> 继续识别
                    </button>
                </div>
            </div>

            <!-- 历史记录区域 -->
            <div id="historySection" class="history-section" style="display: none;">
                <h3><i class="fas fa-history"></i> 历史记录</h3>
                <div class="history-controls">
                    <button id="selectAllBtn" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                        <i class="fas fa-check-square"></i> 全选
                    </button>
                    <button id="selectNoneBtn" class="btn btn-sm btn-outline-secondary" onclick="selectNone()">
                        <i class="fas fa-square"></i> 取消全选
                    </button>
                    <span class="selected-count">已选择: <span id="selectedCount">0</span> 条记录</span>
                </div>
                <div class="table-responsive">
                    <table id="historyTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th width="150">导入时间</th>
                                <th width="120">Numero Documento</th>
                                <th width="100">Quantita</th>
                                <th>Descrizione Articolo</th>
                                <th width="100">操作</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- 历史记录将在这里动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 批量操作按钮 -->
                <div class="batch-actions">
                    <button id="exportSelectedBtn" class="btn btn-primary" onclick="exportSelected()" disabled>
                        <i class="fas fa-download"></i> 导出选中记录
                    </button>
                    <button id="printSelectedBtn" class="btn btn-secondary" onclick="printSelected()" disabled>
                        <i class="fas fa-print"></i> 打印选中记录
                    </button>
                    <button id="deleteSelectedBtn" class="btn btn-danger" onclick="deleteSelected()" disabled>
                        <i class="fas fa-trash"></i> 删除选中记录
                    </button>
                </div>
            </div>

            <!-- 消息提示区域 -->
            <div id="messageArea"></div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentSessionId = null;
        let currentData = null;
        let historyData = [];
        let cameraStream = null;

        // DOM 元素
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const results = document.getElementById('results');
        const displayData = document.getElementById('displayData');
        const editForm = document.getElementById('editForm');
        const historySection = document.getElementById('historySection');
        const historyTableBody = document.getElementById('historyTableBody');
        const messageArea = document.getElementById('messageArea');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadHistoryData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // 拖拽上传
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // 文件选择
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        // 文件处理
        async function handleFile(file) {
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
                showMessage('请选择图片文件或PDF文件！', 'danger');
                return;
            }

            const sessionId = generateSessionId();
            currentSessionId = sessionId;

            showProgress(true);
            updateProgress(10, '准备上传...');

            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const endpoint = file.type === 'application/pdf' ? '/api/pdf-ocr-and-process' : '/api/ocr-and-process';

                updateProgress(30, '正在上传文件...');

                const response = await fetch(`${endpoint}?sessionId=${sessionId}`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(60, '正在识别文档...');

                const data = await response.json();

                updateProgress(100, '识别完成！');

                setTimeout(() => {
                    showProgress(false);
                    if (data.success) {
                        displayResult(data);
                    } else {
                        showMessage(data.message || '识别失败，请重试', 'danger');
                    }
                }, 1000);

            } catch (error) {
                showProgress(false);
                showMessage(`处理失败: ${error.message}`, 'danger');
            }
        }

        // 显示识别结果
        function displayResult(data) {
            currentData = {
                ...data,
                timestamp: new Date().toISOString()
            };

            let html = '';
            const fields = ['Numero Documento', 'Quantita', 'Descrizione Articolo'];
            
            fields.forEach(field => {
                const value = data.extractedFields[field] || '未识别';
                html += `
                    <div class="field-item">
                        <div class="field-label">${field}:</div>
                        <div class="field-value">${value}</div>
                    </div>
                `;
            });

            displayData.innerHTML = html;
            results.style.display = 'block';
            
            // 启用按钮
            document.getElementById('editBtn').disabled = false;
            document.getElementById('addToHistoryBtn').disabled = false;

            showMessage('文档识别完成！您可以编辑结果或添加到历史记录。', 'success');
        }

        // 编辑数据
        function editData() {
            if (!currentData) return;

            // 填充编辑表单
            document.getElementById('editNumeroDocumento').value = currentData.extractedFields['Numero Documento'] || '';
            document.getElementById('editQuantita').value = currentData.extractedFields['Quantita'] || '';
            document.getElementById('editDescrizioneArticolo').value = currentData.extractedFields['Descrizione Articolo'] || '';

            // 显示编辑表单，隐藏显示区域
            editForm.style.display = 'block';
            displayData.style.display = 'none';
        }

        // 保存编辑的数据
        function saveEditedData() {
            const numeroDocumento = document.getElementById('editNumeroDocumento').value.trim();
            const quantita = document.getElementById('editQuantita').value.trim();
            const descrizioneArticolo = document.getElementById('editDescrizioneArticolo').value.trim();

            // 更新当前数据
            currentData.extractedFields = {
                'Numero Documento': numeroDocumento,
                'Quantita': quantita,
                'Descrizione Articolo': descrizioneArticolo
            };

            // 重新显示结果
            displayResult(currentData);
            cancelEdit();
            
            showMessage('数据已保存！', 'success');
        }

        // 取消编辑
        function cancelEdit() {
            editForm.style.display = 'none';
            displayData.style.display = 'block';
        }

        // 添加到历史记录
        function addToHistory() {
            if (!currentData) return;

            // 检查是否已存在相同记录
            const isDuplicate = historyData.some(item => 
                item.extractedFields['Numero Documento'] === currentData.extractedFields['Numero Documento'] &&
                item.extractedFields['Quantita'] === currentData.extractedFields['Quantita'] &&
                item.extractedFields['Descrizione Articolo'] === currentData.extractedFields['Descrizione Articolo']
            );

            if (isDuplicate) {
                showMessage('该记录已存在于历史记录中！', 'warning');
                return;
            }

            // 添加到历史记录
            const historyItem = {
                id: generateId(),
                timestamp: new Date().toISOString(),
                extractedFields: { ...currentData.extractedFields },
                filename: currentData.filename || '未知文件'
            };

            historyData.push(historyItem);
            saveHistoryData();
            renderHistoryTable();
            
            // 显示历史记录区域
            historySection.style.display = 'block';
            
            showMessage('记录已添加到历史记录！', 'success');
        }

        // 渲染历史记录表格
        function renderHistoryTable() {
            if (historyData.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">暂无历史记录</td></tr>';
                return;
            }

            // 按时间倒序排列（最新的在前面）
            const sortedData = [...historyData].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            historyTableBody.innerHTML = sortedData.map(item => `
                <tr>
                    <td>
                        <input type="checkbox" class="record-checkbox" value="${item.id}" onchange="updateSelectedCount()">
                    </td>
                    <td>${formatDateTime(item.timestamp)}</td>
                    <td>${item.extractedFields['Numero Documento'] || '-'}</td>
                    <td>${item.extractedFields['Quantita'] || '-'}</td>
                    <td>${item.extractedFields['Descrizione Articolo'] || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            updateSelectedCount();
        }

        // 选择/取消选择所有记录
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }

        function selectAll() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleSelectAll();
        }

        function selectNone() {
            document.getElementById('selectAllCheckbox').checked = false;
            toggleSelectAll();
        }

        // 更新选中计数
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            const count = checkboxes.length;
            
            document.getElementById('selectedCount').textContent = count;
            
            // 更新批量操作按钮状态
            const hasSelection = count > 0;
            document.getElementById('exportSelectedBtn').disabled = !hasSelection;
            document.getElementById('printSelectedBtn').disabled = !hasSelection;
            document.getElementById('deleteSelectedBtn').disabled = !hasSelection;
        }

        // 导出选中记录
        async function exportSelected() {
            const selectedIds = getSelectedRecordIds();
            if (selectedIds.length === 0) {
                showMessage('请选择要导出的记录！', 'warning');
                return;
            }

            try {
                const selectedRecords = historyData.filter(item => selectedIds.includes(item.id));
                
                // 创建临时会话ID
                const tempSessionId = generateSessionId();
                
                // 发送选中的记录到后端
                const response = await fetch('/api/export-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: tempSessionId,
                        records: selectedRecords
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `FileCognize_Selected_${formatDateTime(new Date().toISOString()).replace(/[:\s]/g, '-')}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showMessage(`成功导出 ${selectedIds.length} 条记录！`, 'success');
                } else {
                    throw new Error('导出失败');
                }
            } catch (error) {
                showMessage(`导出失败: ${error.message}`, 'danger');
            }
        }

        // 打印选中记录
        async function printSelected() {
            const selectedIds = getSelectedRecordIds();
            if (selectedIds.length === 0) {
                showMessage('请选择要打印的记录！', 'warning');
                return;
            }

            try {
                const selectedRecords = historyData.filter(item => selectedIds.includes(item.id));
                
                // 创建临时会话ID
                const tempSessionId = generateSessionId();
                
                // 发送选中的记录到后端生成打印页面
                const response = await fetch('/api/print-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: tempSessionId,
                        records: selectedRecords
                    })
                });

                if (response.ok) {
                    const htmlContent = await response.text();
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(htmlContent);
                    printWindow.document.close();
                    printWindow.focus();
                    
                    // 等待内容加载完成后打印
                    setTimeout(() => {
                        printWindow.print();
                    }, 1000);
                    
                    showMessage(`成功准备打印 ${selectedIds.length} 条记录！`, 'success');
                } else {
                    throw new Error('打印准备失败');
                }
            } catch (error) {
                showMessage(`打印失败: ${error.message}`, 'danger');
            }
        }

        // 删除选中记录
        function deleteSelected() {
            const selectedIds = getSelectedRecordIds();
            if (selectedIds.length === 0) {
                showMessage('请选择要删除的记录！', 'warning');
                return;
            }

            if (confirm(`确定要删除选中的 ${selectedIds.length} 条记录吗？此操作不可撤销。`)) {
                historyData = historyData.filter(item => !selectedIds.includes(item.id));
                saveHistoryData();
                renderHistoryTable();
                
                showMessage(`成功删除 ${selectedIds.length} 条记录！`, 'success');
            }
        }

        // 删除单条记录
        function deleteRecord(id) {
            if (confirm('确定要删除这条记录吗？此操作不可撤销。')) {
                historyData = historyData.filter(item => item.id !== id);
                saveHistoryData();
                renderHistoryTable();
                
                showMessage('记录已删除！', 'success');
            }
        }

        // 获取选中记录的ID
        function getSelectedRecordIds() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        // 相机功能
        async function openCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;
                
                document.getElementById('cameraSection').style.display = 'block';
                document.getElementById('cameraStatus').textContent = '相机已就绪，点击拍照按钮进行识别';
            } catch (error) {
                showMessage('无法访问相机，请检查权限设置', 'danger');
            }
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraSection').style.display = 'none';
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('captureCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                closeCamera();
                handleFile(file);
            }, 'image/jpeg', 0.8);
        }

        // 重置表单
        function resetForm() {
            currentData = null;
            currentSessionId = null;
            
            results.style.display = 'none';
            editForm.style.display = 'none';
            displayData.style.display = 'block';
            
            document.getElementById('editBtn').disabled = true;
            document.getElementById('addToHistoryBtn').disabled = true;
            
            fileInput.value = '';
            
            // 如果有历史记录，显示历史记录区域
            if (historyData.length > 0) {
                historySection.style.display = 'block';
            }
        }

        // 工具函数
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateId() {
            return 'record_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function showProgress(show) {
            progress.style.display = show ? 'block' : 'none';
            if (!show) {
                updateProgress(0, '');
            }
        }

        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = text || `${percent}%`;
        }

        function showMessage(message, type = 'info') {
            const alertClass = `alert-${type}`;
            const iconClass = type === 'success' ? 'fa-check-circle' : 
                             type === 'danger' ? 'fa-exclamation-circle' : 
                             type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            const messageHtml = `
                <div class="alert ${alertClass}">
                    <i class="fas ${iconClass}"></i> ${message}
                </div>
            `;
            
            messageArea.innerHTML = messageHtml;
            
            // 3秒后自动隐藏消息
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }

        // 本地存储功能
        function saveHistoryData() {
            localStorage.setItem('fileCognizeHistory', JSON.stringify(historyData));
        }

        function loadHistoryData() {
            const saved = localStorage.getItem('fileCognizeHistory');
            if (saved) {
                historyData = JSON.parse(saved);
                if (historyData.length > 0) {
                    historySection.style.display = 'block';
                    renderHistoryTable();
                }
            }
        }
    </script>
</body>
</html> 
</html> 